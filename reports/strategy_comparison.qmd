---
title: "Trading Strategy Comparison Report"
author: "Stochastic Risk Assessment"
date: today
format:
  html:
    toc: true
    code-fold: true
    theme: cosmo
execute:
  warning: false
---

```{python}
#| echo: false
import sys
sys.path.append('..')

import pandas as pd
import numpy as np
import matplotlib.pyplot as plt

from backtesting.buyandhold import buy_and_hold_backtest
from backtesting.dca import dca_backtest
from backtesting.rsi import rsi_backtest
from backtesting.macrossovers import ma_crossover_backtest
from backtesting.meanreversion import mean_reversion_backtest
from backtesting.volume import volume_backtest
from backtesting.grid import grid_trading_backtest
from backtesting.momentum import momentum_backtest
from backtesting.breakout import breakout_backtest
from src.metrics.performance import evaluate
```

## Overview

This report compares 9 trading strategies on historical BTC/USDT daily data. Each strategy is evaluated using risk-adjusted metrics including Sharpe Ratio, Sortino Ratio, and Maximum Drawdown.

## Data

```{python}
data_path = "../data/org/marketdata/BTCUSDT_1d_974764800000_1763683200000.csv"
df = pd.read_csv(data_path, index_col=0)
df['open_time'] = pd.to_datetime(df['open_time'])

print(f"Data Period: {df['open_time'].iloc[0].date()} to {df['open_time'].iloc[-1].date()}")
print(f"Total Days: {len(df)}")
print(f"Price Range: ${df['close_price'].min():,.2f} - ${df['close_price'].max():,.2f}")
```

## Strategy Performance

```{python}
#| label: run-strategies
strategies = {
    "Buy & Hold": buy_and_hold_backtest(df),
    "DCA Weekly": dca_backtest(df, frequency='weekly'),
    "RSI (14)": rsi_backtest(df),
    "MA Crossover (50/200)": ma_crossover_backtest(df),
    "Mean Reversion": mean_reversion_backtest(df),
    "Volume Spike": volume_backtest(df),
    "Grid Trading": grid_trading_backtest(df),
    "Momentum": momentum_backtest(df),
    "Breakout": breakout_backtest(df),
}

results = []
for name, result in strategies.items():
    metrics = evaluate(result, periods_per_year=365)
    results.append({
        'Strategy': name,
        'Total Return (%)': metrics['total_return_pct'],
        'Annualized Return (%)': metrics['annualized_return_pct'],
        'Sharpe Ratio': metrics['sharpe_ratio'],
        'Sortino Ratio': metrics['sortino_ratio'],
        'Max Drawdown (%)': metrics['max_drawdown_pct'],
        'Win Rate (%)': metrics['win_rate_pct'],
        'Volatility (%)': metrics['annualized_volatility_pct'],
    })

results_df = pd.DataFrame(results)
```

### Summary Table

```{python}
#| label: tbl-summary
styled = results_df.style.format({
    'Total Return (%)': '{:.1f}',
    'Annualized Return (%)': '{:.1f}',
    'Sharpe Ratio': '{:.2f}',
    'Sortino Ratio': '{:.2f}',
    'Max Drawdown (%)': '{:.1f}',
    'Win Rate (%)': '{:.1f}',
    'Volatility (%)': '{:.1f}',
}).background_gradient(subset=['Sharpe Ratio'], cmap='RdYlGn')

styled
```

### Sharpe Ratio Ranking

```{python}
#| label: fig-sharpe
#| fig-cap: "Sharpe Ratio by Strategy (higher is better)"
fig, ax = plt.subplots(figsize=(10, 6))
sorted_df = results_df.sort_values('Sharpe Ratio', ascending=True)
colors = ['green' if x > 0 else 'red' for x in sorted_df['Sharpe Ratio']]
ax.barh(sorted_df['Strategy'], sorted_df['Sharpe Ratio'], color=colors)
ax.axvline(x=0, color='black', linestyle='-', linewidth=0.5)
ax.set_xlabel('Sharpe Ratio')
ax.set_title('Risk-Adjusted Performance (Sharpe Ratio)')
plt.tight_layout()
plt.show()
```

### Return vs Risk

```{python}
#| label: fig-risk-return
#| fig-cap: "Return vs Volatility Scatter Plot"
fig, ax = plt.subplots(figsize=(10, 6))
ax.scatter(results_df['Volatility (%)'], results_df['Annualized Return (%)'], s=100)
for i, row in results_df.iterrows():
    ax.annotate(row['Strategy'], (row['Volatility (%)'], row['Annualized Return (%)']),
                textcoords="offset points", xytext=(5, 5), fontsize=8)
ax.axhline(y=0, color='gray', linestyle='--', alpha=0.5)
ax.set_xlabel('Volatility (%)')
ax.set_ylabel('Annualized Return (%)')
ax.set_title('Risk-Return Profile')
plt.tight_layout()
plt.show()
```

### Maximum Drawdown Comparison

```{python}
#| label: fig-drawdown
#| fig-cap: "Maximum Drawdown by Strategy (less negative is better)"
fig, ax = plt.subplots(figsize=(10, 6))
sorted_dd = results_df.sort_values('Max Drawdown (%)', ascending=False)
ax.barh(sorted_dd['Strategy'], sorted_dd['Max Drawdown (%)'], color='darkred')
ax.set_xlabel('Max Drawdown (%)')
ax.set_title('Maximum Drawdown (Capital Preservation)')
plt.tight_layout()
plt.show()
```

## Equity Curves

```{python}
#| label: fig-equity
#| fig-cap: "Portfolio Value Over Time"
fig, ax = plt.subplots(figsize=(12, 6))

for name, result in strategies.items():
    pv = result['portfolio_values']
    timestamps = result['timestamps']
    # Normalize to starting value of 100
    normalized = (pv / pv.iloc[0]) * 100
    ax.plot(timestamps, normalized, label=name, alpha=0.7)

ax.set_xlabel('Date')
ax.set_ylabel('Normalized Value (Starting = 100)')
ax.set_title('Strategy Equity Curves')
ax.legend(loc='upper left', fontsize=8)
ax.grid(True, alpha=0.3)
plt.tight_layout()
plt.show()
```

## Key Findings

```{python}
#| echo: false
best_sharpe = results_df.loc[results_df['Sharpe Ratio'].idxmax()]
best_return = results_df.loc[results_df['Total Return (%)'].idxmax()]
lowest_dd = results_df.loc[results_df['Max Drawdown (%)'].idxmax()]
```

1. **Best Risk-Adjusted Return**: `{python} best_sharpe['Strategy']` with Sharpe Ratio of `{python} f"{best_sharpe['Sharpe Ratio']:.2f}"`

2. **Highest Total Return**: `{python} best_return['Strategy']` with `{python} f"{best_return['Total Return (%)']:.1f}%"` return

3. **Best Capital Preservation**: `{python} lowest_dd['Strategy']` with max drawdown of `{python} f"{lowest_dd['Max Drawdown (%)']:.1f}%"`

## Methodology

- **Initial Capital**: $10,000 (except DCA which invests $100/week)
- **Period**: `{python} f"{df['open_time'].iloc[0].date()}"` to `{python} f"{df['open_time'].iloc[-1].date()}"`
- **Metrics**:
  - Sharpe Ratio: (Return - Risk Free) / Volatility
  - Sortino Ratio: Uses only downside volatility
  - Max Drawdown: Largest peak-to-trough decline
  - Win Rate: Percentage of positive return days

---
*Report generated automatically from backtesting framework*
